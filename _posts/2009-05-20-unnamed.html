---
layout: post
title: unknown post 
---
<p>In February 2009 a mac security update broke my perl installation. You can read more about that on this <a href='http://developers.slashdot.org/article.pl?sid=09/02/18/143522'>Slashdot article</a> (http://hivelogic.com/articles/view/top-10-programming-fonts) , ulimatly forcing me to reinstall my entire system. One of the main reasons for this is that I had a hevily customized perl setup as part of installing Connotea and I based this on top of the system perl. This was a bad idea, but was the quickest way to get Connotea up and running on my local machine at the time.</p><br /><br /><p>Having learnt my lesson I decided to set up Connotea on a totally sepearte perl install. The following instructions assume a totally clean machine to begin with. You will need to have the <a href='http://developer.apple.com/Tools/'>Apple Developer Tools</a> installed.</p><br /><br /><p>For installing on a clean <em>nix please follow the instructions in the main README file.</em></p><br /><br /><p>Connotea is written in perl and uses mod_perl under apache to talk to a MySQL datastore. The code uses memcached to help with preformance. It uses a large number of perl modules that need to be installed before the software can run. This guide will run through setting up all of the required depedancies.</p><br /><br /><p>Before getting to installing Connotea let&#8217;s set up our dependancies.</p><br /><br /><h2 id='a_word_on_macports_vs_compiling_your_own'>A word on MacPorts vs compiling your own.</h2><br /><br /><p>Bauhaus has a very nice description on how to set up a <a href='http://bauhouse.wordpress.com/2008/06/28/setting-up-a-development-environment-in-mac-os-x/'>dev environment in OS X</a>, however the description here depends hevily on <a href='http://www.macports.org/'>MacPorts</a>. MacPorts is an easy way to install software onto your mac, and it will do so in a way that will not conflict with system installs, however it provides the wrong architecture for perl for Connotea, so you will have to install perl and all of the perl dependancies seperatly. This is a bit of a shame, as installing the dependancies is much faster under MacPorts than it is under <a href='http://www.cpan.org/'>CPAN</a>. We can install some of the required architecture under MacPorts and that is what we will do. One last note about MacPorts. It will install a very large amount of dependancies onto your system. This is expected, though scary, behaviour. Don&#8217;t worry.</p><br /><br /><p>In order to use MacPorts you can install an <span>application</span><a href='http://www.macports.org/install.php'>portsapp</a>. After installing you can get the port version of a given piece of software with hte following command:</p><br /><br /><pre class="console"><br />$ sudo port install port-name<br /></pre><br /><br /><p>where port-name is the software you want to install. MacPorts creates it&#8217;s own path system and will install into</p><br /><br /><p>$ /opt</p><br /><br /><h2 id='mysql'>MySQL</h2><br /><br /><p>Download the package from the <a href='http://www.mysql.com/'>MySQL site</a> and follow the instructions for installation. For a quick cheat sheet of common commands for MySql under OS X there is a great <a href='http://www.comentum.com/mysql-administration.html'>MySQL Reference for OS X</a> over at Comentum.</p><br /><br /><p>After installing the most important commands are to set an admin password, to start the server and to stop the server.</p><br /><br /><p>setting the root password: $ /usr/local/mysql/bin/mysqladmin -u root password sniggle</p><br /><br /><p>starting and stopping from the command line: $ sudo /usr/local/mysql/bin/mysqld_safe &#8211;user=mysql &amp;</p><br /><br /><p>If you wish to set preferennces for MySQL when it is running you can create a conf file. This should be under /etc and should be called my.cnf.</p><br /><br /><h1 id='make_sure_you_know_where_your_socks_are'>Make sure you know where your socks are.</h1><br /><br /><p>There is a <a href='http://www.linuxforums.org/forum/servers/1451-what-mysql-sock-file.html'>known issue with MySQL under OS X</a> in that the location for the socket file is not where OS X thinks it is. There are a number of solutions to this. <br />Edit the my.cnf file so that the mysql server creates a sock file in a location of your choosing. Reccomended like so:</p><br /><br /><p><span>mysqld</span> socket=/tmp/mysql.sock</p><br /><br /><p>Now if you are using a perl installed via MacPorts and you want to use a non-mac ports version of mysql then you might encounter the following problem with the DBI module.</p><br /><br /><blockquote><br /><p>failed: Can&#8217;t connect to local MySQL server through socket &#8216;/opt/local/var/run/mysql5/mysqld.sock&#8217;</p><br /></blockquote><br /><br /><p>What is going on here is that the DBI module is reading a setting telling it that the mysql socket should be found in &#8216;/opt/local/var/run/mysql5/mysqld.sock&#8217;. I&#8217;m not sure where it gets this setting from but there are a couple of options.</p><br /><br /><ol><br /><li>Use a mac ports version of mysql. See</li><br /></ol><br /><br /><ul><br /><li>http://www.hennessynet.com/blog/?p=40</li><br /><br /><li>http://www.martinoflynn.com/blog/2008/08/13/installing-mysql-on-mac-os-x-105/</li><br /><br /><li>http://2tbsp.com/content/install_and_configure_mysql_5_macports</li><br /></ul><br /><br /><ol><br /><li>Specifically tell the DBI module where to look for the socect. In any perl scripts that call the DBI module you can use the following command to specify the location of the socket file:</li><br /></ol><br /><br /><p>$ENV{MYSQL_UNIX_PORT}=&#8217;/tmp/mysql.sock&#8217;;</p><br /><br /><p>Place this in your script after you call the DBI module.</p><br /><br /><ol><br /><li>You can alias your actual sock file to the location that the DBI module is expecting it, via:</li><br /></ol><br /><br /><p>$ sudo ln -s /tmp/mysql.sock /opt/local/var/run/mysql5/mysqld.sock</p><br /><br /><p>you may have to create the /opt/local/var/run/mysql/ directory.</p><br /><br /><p>You may wish to create an alias so that this link does not get removed on server start up.</p><br /><br /><h2 id='apache2'>Apache2</h2><br /><br /><p>This is where MacPorts comes in handy. To install apache2 all you need to do is</p><br /><br /><p>$sudo port install apache2</p><br /><br /><p>This will install a number of dependancies on your system, and it will install apace2 into /aop/local/apace2. You can start apache2 and ensure that it starts at next startup with the follwoing command:</p><br /><br /><p>$sudo launchctl load -w /Library/LaunchDaemons/org.macports.apache2.plist</p><br /><br /><p>You can test that it works by pointing your browser at http://localhost/ and you should get an &#8220;It Works!&#8221; message!</p><br /><br /><p>If you want to start and stop apache2 while working on the configuration of the server, or to check your sanity then you can use the following cammands:</p><br /><br /><p>$ sudo /opt/local/apache2/bin/apachectl stop $ sudo /opt/local/apache2/bin/apachectl start</p><br /><br /><h2 id='memcached'>memcached</h2><br /><br /><p>Using the Macports version this is pretty easy.</p><br /><br /><blockquote><br /><p>sudo port install memcached</p><br /></blockquote><br /><br /><h2 id='a_few_words_about_cpan'>A few words about CPAN</h2><br /><br /><p>There is a comprehensive description of life under <a href='http://sial.org/howto/perl/life-with-cpan/'>CPAN on OSX</a> however I decided to wing it. I dislike CPAN. It is a very attention demanding program that has a tendancy to want a lot of attention. It is nice to know that you can install modules from the command line with the following syntax:</p><br /><br /><p>$sudo cpan -i -f URI::QueryParam</p><br /><br /><p>This means if you can get a list of dependancies together then you can semi-automate the process of install them all. I understand that the preferred method of managing a large selection of perl dependancies to is create a CPAN Bundle, but I didn&#8217;t manage to do this, mainly due to a lack of familliarity with CPANishness. It is also worth noting that if CPAN is not able to install a module you can always have a go at downloading and installing the modeule from source. This is often quite straightforward.</p><br /><br /><h2 id='perl'>perl</h2><br /><br /><p>As mentioned earlier, MacPorts do not porvide the correct type of perl for running Connotea. Connotea requires &#8216;PerlOptions +Parent&#8217; in the Apache configuration file. This requires a multithreaded perl. MacPorts only provides a perl without threads. This means you have to build your own perl. You can check which version of perl you have installed with the following command</p><br /><br /><p>$perl -V</p><br /><br /><p>What you want to end up with is the following:</p><br /><br /><p>Platform: osname=darwin, osvers=9.6.0, archname=darwin-thread-multi-2level</p><br /><br /><p>Go ahead and grab a copy of <a href='http://www.perl.org/'>Perl</a>. You pretty much want to follow the instructions given in the README.macosx file. You want to make sure that you build perl with multithreaded support. I followed a lot of instructions for passing arguments to the Configure script without much success. In the end I think that my mistake was passing the &#8216;-de&#8217; flag which tells the script to accept the default settings. Don&#8217;t do this, just go through the interrogation and at some point you will be asked if you want to build with multithreaded support. Say YES!!. Hopefully you will end up with a perl now installed in /usr/local/bin/perl. This will be independant from the system perl and you will no longer be sucseptible to Apple fucking you over (allbeit unintentionally). Now when you build anything on top of this perl it will have the same architectural support (I believe), so you can now make mod_perl on top of this perl. One tip for speeding up the process, if you have a multi-core machine you can pass an argument to make which will tell it to use the number of cores that you pass it to, so</p><br /><br /><p>$make -j 2</p><br /><br /><p>will make twice as fast as make.</p><br /><br /><h2 id='mod_perl'>mod_perl</h2><br /><br /><p>Get a copy of <a href='http://perl.apache.org/download/index.html'>mod_perl</a>. Go into your mod_perl source directory and from there do the following:</p><br /><br /><p>$perl Makefile.PL MP_APXS=/opt/local/apache2/bin/apxs $make &amp;&amp; make test</p><br /><br /><p>after a lengthy build process you should be ready to install with:</p><br /><br /><p>$sudo make install</p><br /><br /><p>In /opt/local/apache2/modules you should now find mod_perl.so. We can now test our mod_perl to see if everyting is OK. Have a look at the <a href='http://perl.apache.org/docs/2.0/user/intro/start_fast.html'>fast guide to getting started with mod_perl</a> and follow the instructions there.</p><br /><br /><p>To set up a test of mod_perl we need to edit apache&#8217;s httpd.conf file which can be found: /opt/local/apache2/conf/httpd.conf</p><br /><br /><p>Add the mod_perl module by adding the following line to the conf file</p><br /><br /><p>LoadModule perl_module modules/mod_perl.so</p><br /><br /><p>Stop and restart your apache2 server and take a peek at the error log, you should get a line like the following:</p><br /><br /><p>$tail /opt/local/apache2/logs/ <span>Thu Apr 23 14:59:22 2009</span> Apache/2.2.11 (Unix) mod_ssl/2.2.11 OpenSSL/0.9.8j DAV/2 mod_perl/2.0.4 Perl/v5.8.9 configured &#8211; resuming normal operations</p><br /><br /><p>yay!</p><br /><br /><h2 id='perl_dependancies'>perl dependancies</h2><br /><br /><p>OK, Connotea requies a lot of dependancies, most of which can be installed through CPAN, a few which need to be manually installed. I&#8217;ve provided a file 1.8.extended.deplist.txt that contains what I believe to be the current set of modules that Connotea requires. If you pass the list of names into check-modules.py then you can check whether these modules have been installed. Passing any argument into the script will produce verobse output. Passing no arguments will just list the modules that have not been installed.</p><br /><br /><p>For the time being please ignore the following modules:</p><br /><br /><p>Apache2 Apache::Const Apache::File File::Touch Net::OpenID::JanRain::Consumer</p><br /><br /><p>$more 1.8.extended.deplist.txt | ./check-modules.py verbose</p><br /><br /><p>You can generate a shell script to install non-installed modules via CPAN with the following command:</p><br /><br /><p>$more 1.8.extended.deplist.txt | ./check-modules.py | awk &#8216;{print &#8220;sudo cpan -i &#8221; $1}&#8217; &gt; install-modules.sh</p><br /><br /><p>and then:</p><br /><br /><p>$chmod u+x install-modules.sh $sudo ./install-modules.sh</p><br /><br /><p>This will take some time. The CPAN interface is slow and requires a lot of intervention. If you get stuck with CPAN for a given module, then download the module and install from source.</p><br /><br /><p>I had to manually install Authen::Captcha http://search.cpan.org/dist/Authen-Captcha/Captcha.pl</p><br /><br /><h2 id='connotea_code'>Connotea code</h2><br /><br /><p>The most recent public version of the Connotea code is now on GitHub under the name <a href='http://github.com/IanMulvany/connotea-public/tree/master'>connotea-public</a>. The main working branch is still under darcs, however we are in the process of switching over to git as the time to upload local patches to the dev server is becomming prohibitive. We may move to mercurial at some point in time, but for the time being the public facing snapshot will remain in git. Head on over and grab a copy. The main files of interest for continuing the setup will be in /connotea-public/sql/, /connotea-public/README, and /connotea-pulic/config</p><br /><br /><h2 id='setup_mysql_databases_and_permissions'>Setup MySQL databases and permissions</h2><br /><br /><p>Connotea uses a four databases. The main content database, the search database which is a replica of the content database, a click tracking database and the wiki database. The content database is a MyISAM database, and the search database is an InnoDB database. The schema for the content database is provided by schema.sql in the sql directory. To generate the search database do the following:</p><br /><br /><p>$perl mkschema_search &lt; schema.sql &gt; schema_search.sql</p><br /><br /><p>Now set up the schema of the content database and the search database:</p><br /><br /><p>$mysql -u root -p &lt; schema.sql $mysql -u root -p &lt; schema_search.sql $mysql -u root -p &lt; clicks.sql</p><br /><br /><p>You need to set up the search database to be a slave of the content database. This is done in the MySQL conf file by adding the following directives:</p><br /><br /><pre><code>  [mysqld]<br />  # local replication of bibliotech to bibliotech_search:<br />  server-id=1<br />  log-bin=mysql-bin<br />  binlog-do-db=bibliotech<br />  replicate-same-server-id=1<br />  replicate-rewrite-db=bibliotech-&gt;bibliotech_search<br />  replicate-do-db=bibliotech_search<br />  master-host=localhost<br />  master-user=search_repl<br />  master-password=pass</code></pre><br /><br /><p>You may want to add the folloing directive too:</p><br /><br /><pre><code>  # change stopwords in support of bibliotech freematch feature:<br />  #ft_stopword_file=/etc/mysql_stopwords.txt<br />  ft_min_word_len=2<br />  ft_max_word_len=255<br />  # allow packing of queries<br />  group_concat_max_len=8192</code></pre><br /><br /><p>You now need to set up the appropriate permissions form within MySQL for the following users &#8216;conwiki&#8217;, &#8216;search_repl&#8217; and &#8216;connotea&#8217;:</p><br /><br /><p>mysql&gt; GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, CREATE TEMPORARY TABLES, ALTER ON bibliotech_search.* TO -&gt; connotea@localhost identified by &#8216;secret&#8217;;</p><br /><br /><p>mysql&gt; GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, CREATE TEMPORARY TABLES, ALTER ON bibliotech.* TO -&gt; connotea@localhost identified by &#8216;secret&#8217;;</p><br /><br /><p>mysql&gt; GRANT REPLICATION SLAVE, REPLICATION CLIENT ON <em>.</em> TO -&gt; search_repl@&#8217;localhost.localdomain&#8217; IDENTIFIED BY &#8216;secret&#8217;;</p><br /><br /><p>We now need to set up the wiki database. This is done through the following command:</p><br /><br /><p>mysql&gt;CREATE DATABASE conwiki; mysql&gt;GRANT ALL ON conwiki.* TO conwiki@localhost IDENTIFIED BY &#8216;secret&#8217;;</p><br /><br /><p>To set up the schema we just let wiki-toolkit-setupdb have at it:</p><br /><br /><p>$/usr/local/bin/wiki-toolkit-setupdb &#8211;type mysql \ &#8211;name conwiki \ &#8211;user conwiki \ &#8211;pass secret \ &#8211;host localhost</p><br /><br /><p>Remember to populate the &#8220;COMPONENT WIKI&#8221; block of your configuration file with the wiki database details.</p><br /><br /><p>Connotea will be informed of the database that it needs to connect to in the conf file. I would say that it goes without saying that the passwords all need to be congruent, but I keep messing up that part, so I&#8217;m not going to say that.</p><br /><br /><h2 id='setup_apache_directives_and_paths_to_the_code'>Setup Apache directives and paths to the code.</h2><br /><br /><p>Ok, now we have mysql sitting there waiting to act as a data store. We have the connotea code. We just need to connect these together and to the outside world through the magic of apace and mod_perl.</p><br /><br /><p>You need to add a directive like the following to your apace conf file. Remeber, that file should be in /opt/local/apache2/conf/httpd.conf</p><br /><br /><h1 id='change_the_document_root_as_we_are_going_to_host_connotea_from'>change the document root, as we are going to host connotea from</h1><br /><br /><h1 id='a_more_traditional_location'>a more traditional location</h1><br /><br /><h1 id='documentroot_optlocalapache2htdocs'>DocumentRoot &#8220;/opt/local/apache2/htdocs&#8221;</h1><br /><br /><p>DocumentRoot &#8220;/var/www/html&#8221;</p><br /><br /><h1 id='ensure_that_we_can_follow_symlinks'>ensure that we can follow symlinks:</h1><br /><pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: <br />&lt;Directory &quot;/var/www/html&quot;&gt;<br />    #<br />    # Possible values for the Options directive are &quot;None&quot;, &quot;All&quot;,<br />    # or any combination of:<br />    #   Indexes Includes FollowSymLinks SymLinksifOwnerMatch ExecCGI MultiViews<br />    #<br />    # Note that &quot;MultiViews&quot; must be named *explicitly* --- &quot;Options All&quot;<br />    # doesn&apos;t give it to you.<br />    #<br />    # The Options directive is both complicated and important.  Please see<br />    # http://httpd.apache.org/docs/2.2/mod/core.html#options<br />    # for more information.<br />    #<br />    Options Indexes FollowSymLinks<br /><br />    #<br />    # AllowOverride controls what directives may be placed in .htaccess files.<br />    # It can be &quot;All&quot;, &quot;None&quot;, or any combination of the keywords:<br />    #   Options FileInfo AuthConfig Limit<br />    #<br />    AllowOverride None<br /><br />    #<br />    # Controls who can get stuff from this server.<br />    #<br />    Order allow,deny<br />    Allow from all<br /><br />&lt;/Directory&gt;</pre><br /><h1 id='add_directives_for_connotea'>add directives for connotea</h1><br /><pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: <br />&lt;VirtualHost 127.0.0.1&gt;<br />        ServerName local.connotea.com<br />        ServerAlias *local.connotea.com<br />        ServerAdmin ian@mulvany.net<br />        DocumentRoot /var/www/html/connotea<br />        PerlOptions +Parent<br />        PerlSwitches -I/var/www/perl/connotea<br />        PerlModule Bibliotech::Apache<br />        PerlModule Bibliotech::AuthCookie<br />        &lt;Location /&gt;<br />          SetHandler perl-script<br />          PerlHandler Bibliotech::Apache<br />          PerlAuthenHandler Bibliotech::AuthCookie::authen_handler<br />          AuthName Bibliotech<br />          AuthType basic<br />          require valid-user<br />          #ErrorDocument 503 /paused.html<br />          #ErrorDocument 503 /readonly.html<br />          ErrorDocument 503 /unavailable.html<br />        &lt;/Location&gt;</pre><pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: <br />&lt;/VirtualHost&gt;</pre><br /><p>In your /etc/hosts file add the following line:</p><br /><br /><ol><br /><li><br /><li><br /><li>1 local.connotea.com</li><br /></li><br /></li><br /></ol><br /><br /><p>This means you can point your browser at local.connotea.com and see the local installation.</p><br /><br /><p>in /var/www create perl, html and site</p><br /><br /><p>in /var/www/site create the directory connotea and place the source code in there.</p><br /><br /><p>create the following symlinks:</p><br /><br /><p>/var/www/perl/connotea -&gt; ../site/connotea</p><br /><br /><p>and</p><br /><br /><p>/var/www/html/connotea -&gt; ../perl/connotea/site/npg</p><br /><br /><p>Make sure that the paths to the code is readable by apache. That also means that the full paths have to be readable by apache.</p><br /><br /><h2 id='set_up_the_connotea_conf_file'>Set up the connotea conf file.</h2><br /><br /><p>copy /connotea-code/confi to /etc/bibliotech.conf</p><br /><br /><p>The most important declarations to set up are the following:</p><br /><br /><p>DOCROOT = &#8216;/var/www/perl/connotea_code/site/default&#8217; LOCATION = &#8216;http://www.mydomain.com/&#8217; DBI_CONNECT = &#8216;dbi:mysql:bibliotech&#8217; DBI_USERNAME = &#8216;user&#8217; DBI_PASSWORD = &#8216;secret&#8217;</p><br /><br /><h1 id='just_the_database_name_of_the_replicated_myisam_fulltextenabled_database'>just the database name of the replicated MyISAM FULLTEXT-enabled database</h1><br /><br /><p>DBI_SEARCH = &#8216;bibliotech_search&#8217;</p><br /><br /><h1 id='for_debugging_purposes_set_explain_http_codes_to_true'>for debugging purposes set EXPLAIN_HTTP_CODES to true</h1><br /><br /><h1 id='set_it_to_false_when_you_have_everything_running'>set it to false when you have everything running.</h1><br /><br /><h1 id='it_causes_application_errors_to_be_printed_to_the_requesting_page'>It causes application errors to be printed to the requesting page.</h1><br /><br /><p>EXPLAIN_HTTP_CODES = true</p><br /><br /><p>CLICKS { # options regarding click tracking # database connection details DBI_CONNECT = &#8216;dbi:mysql:clicks&#8217; DBI_USERNAME = &#8216;user&#8217; DBI_PASSWORD = &#8216;secret&#8217; }</p><br /><br /><p>COMPONENT WIKI { #DBI_CONNECT = &#8216;dbi:mysql:conwiki&#8217; #DBI_USERNAME = &#8216;conwiki&#8217; #DBI_PASSWORD = &#8216;secret&#8217; #ADMIN_USERS = <span>&#8216;admin&#8217;</span> #LOCK_TIME = &#8216;10 MINUTE&#8217; #ALLOW_EDIT = true #HOME_NODE = &#8216;System:Home&#8217; # page size limit is in characters #MAX_PAGE_SIZE = 40000 # maximum external hyperlink count, cuts down on spam #MAX_EXT_LINKS = 75 # scan: 1 means check text against ANTISPAM &gt; TAG_REALLY_BAD_PHRASE_LIST # scan: 2 means check text against ANTISPAM &gt; WIKI_BAD_PHRASE_LIST+TAG_REALLY_BAD_PHRASE_LIST #SCAN = 1 # to admit the spam rule that rejects wiki text, set this to true: #SAY_SPAM_RULE = false }</p><br /><br /><h1 id='sendmail_needs_to_be_set_to_the_os_x_path'>sendmail needs to be set to the OS X path.</h1><br /><br /><p>SENDMAIL = &#8216;/usr/sbin/sendmail&#8217;</p><br /><br /><h2 id='final_adjustments'>Final adjustments</h2><br /><br /><p>Ensure that antispam_score.csv is writable by connotea.</p><br /><br /><h2 id='turn_it_on'>Turn it on.</h2><br /><br /><p>You should be able to run the application now.</p><br /><br /><h2 id='gotchas'>Gotcha&#8217;s</h2><br /><br /><p>In a previous installaion I had problems getting the perl GD module installed</p><br /><br /><p>You need to downgrade LWP, use the following to find out which version of a perl module you have installed. Follow the instructions at this site to get this installed:</p><br /></body></html><br />
